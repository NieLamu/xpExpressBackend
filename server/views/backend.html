<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>弦圃智能科技 - 后台</title>

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="/static/lib/jquery/jquery.min.js"></script>
    <script src="/static/lib/jquery/jquery.form.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css">
    <script src="/static/lib/bootstrap/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/static/lib/bootstrap-table/bootstrap-table.min.css">
    <script src="/static/lib/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/static/lib/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>

    <!--paho-mqtt-->
    <script src="/static/lib/eclipse/paho-mqtt.js"></script>

    <!--moment-->
    <script src="/static/lib/moment/moment.min.js"></script>
    <script src="/static/lib/moment/locale/zh-cn.js"></script>
    <!--tempusdominus-bootstrap-->
    <link rel='stylesheet' href='/static/lib/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css'/>
    <script src="/static/lib/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>

    <!--fontawesome-->
    <script defer src="/static/lib/fontawesome/js/all.min.js"></script>

    <link rel='stylesheet' href='/static/css/style.css'/>
    <script src="/static/js/main.js"></script>
    <script src="/static/js/mqtt_manager.js"></script>

</head>
<body>

<!-- 顶部导航 -->
<div class="headerPage"></div>
<!--顶部导航 over-->

<div class="row">
    <div class="col-lg-2 col-sm-3">
        <div class="nav flex-column nav-pills nav-justified" id="mainTab" role="tablist" aria-orientation="vertical">
            <div class="alert alert-info" role="alert">
                欢迎，<%= userName %>
                <form action="/backend/logout" id="logoutForm" method="get">
                    <button type="submit" class="btn btn-link">退出</button>
                </form>
            </div>
            <a class="nav-link active" id="home-tab" href="#home" role="tab" aria-controls="home" aria-selected="true">首页</a>
            <a class="nav-link" id="genRedeemCode-tab" href="#genRedeemCode" role="tab" aria-controls="genRedeemCode" aria-selected="false">兑换码生成</a>
            <a class="nav-link" id="genReport-tab" href="#genReport" role="tab" aria-controls="genReport" aria-selected="false">生成报告</a>
            <a class="nav-link" id="searchUser-tab" href="#searchUser" role="tab" aria-controls="searchUser" aria-selected="false">搜索用户</a>
        </div>
    </div>
    <div class="col-lg-10 col-sm-9">
        <div class="tab-content" id="mainTabContent">

            <!--homeTab-->
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="row">
                    <div class="col-sm-2"></div>
                    <div class="col-sm-8">
                        <table class="table table-bordered">
                            <thead class="thead-light thead-dark">
                            <tr>
                                <th scope="col">常用站点</th>
                                <th scope="col"></th>
                                <th scope="col"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td><a href="http://report.5ibody.com:7080/zentaopms/www/index.php" target="_blank" class="alert-link">禅道</a></td>
                                <td><a href="http://report.5ibody.com:9080" target="_blank" class="alert-link">认证Git</a></td>
                                <td><a href="http://download.5ibody.com" target="_blank" class="alert-link">APP下载</a></td>
                            </tr>
                            <tr>
                                <td><a href="http://192.168.1.175:9080/frontend" target="_blank" class="alert-link">前台项目组</a></td>
                                <td><a href="http://192.168.1.175:9080/backend" target="_blank" class="alert-link">后台项目组</a></td>
                                <td><a href="http://192.168.1.175:9080/AI" target="_blank" class="alert-link">AI项目组</a></td>
                            </tr>
                            <tr>
                                <td><a href="http://report.5ibody.com:8075/menu" target="_blank" class="alert-link">后台菜单</a></td>
                                <td><a href="http://report.5ibody.com:8075/report/queryDiagnoseReports" target="_blank" class="alert-link">查看报告</a></td>
                                <td><a href="http://report.5ibody.com:8075/ecg/monitor" target="_blank" class="alert-link">心电图监控</a></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-sm-2"></div>
                </div>
            </div>

            <!--genRedeemCodeTab-->
            <div class="tab-pane fade" id="genRedeemCode" role="tabpanel" aria-labelledby="genRedeemCode-tab">
                <div class="row">
                    <div class="col-sm-2"></div>
                    <div class="col-sm-8">

                        <form id="genRedeemCodeForm" action="/backend/genRedeemCode" method="post">
                            <!--类型-->
                            <div class="form-group">
                                <label for="redeemCodeType">兑换码类型</label>
                                <select class="form-control" id="redeemCodeType" name="redeemCodeType">
                                    <option value="exercise">自测锻炼</option>
                                    <option value="changepwd">修改密码</option>
                                    <option value="deleteacc">注销账号</option>
                                </select>
                            </div>
                            <!--个数-->
                            <div class="form-group">
                                <label for="redeemCodeNum">兑换码个数</label>
                                <input type="number" class="form-control" id="redeemCodeNum" placeholder="1" value="1" min="1" max="5" name="redeemCodeNum" required>
                            </div>
                            <!--提交-->
                            <small class="form-text text-muted">请慎重选择兑换码类型和个数.</small>
                            <button type="submit" id="genRedeemCodeSubmit" class="btn btn-outline-info btn-block">生成兑换码</button>

                        </form>

                        <!--结果-->
                        <div class="alert alert-danger genRedeemCode result" role="alert">获取兑换码失败，请稍后重试。</div>
                        <div class="alert alert-success genRedeemCode result" role="alert">已生成兑换码，请复制后妥善保存。<br></div>
                    </div>
                    <div class="col-sm-2"></div>
                </div>
            </div>

            <!--genReportTab-->
            <div class="tab-pane fade" id="genReport" role="tabpanel" aria-labelledby="genReport-tab">
                <div class="row">
                    <div class="col-sm-2"></div>
                    <div class="col-sm-8">
                        <form id="genReportForm" targetp="_blank" action="http://ai.5ibody.com/genBigReport" method="post">

                            <!--用户-->
                            <div class="form-group">
                                <label for="reportUsers">需要生成报告的用户手机号（每行一个）</label>
                                <textarea class="form-control" id="reportUsers" rows="5" name="reportUsers" required></textarea>
                            </div>

                            <!--开始日期-->
                            <div class="form-group">
                                <label for="reportTimeStart">开始日期</label>
                                <div class="input-group date" id="reportTimeStart" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" data-target="#reportTimeStart" name="reportTimeStart" required>
                                    <div class="input-group-append" data-target="#reportTimeStart" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>

                            <!--结束日期-->
                            <div class="form-group">
                                <label for="reportTimeEnd">结束日期</label>
                                <div class="input-group date" id="reportTimeEnd" data-target-input="nearest">
                                    <input type="text" class="form-control datetimepicker-input" data-target="#reportTimeEnd"  name="reportTimeEnd" required>
                                    <div class="input-group-append" data-target="#reportTimeEnd" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                    </div>
                                </div>

                            </div>

                            <!--一份报告包含最大分钟数-->
                            <div class="form-group">
                                <label for="minuteLimit">一份报告包含最大分钟数（默认24小时，即1440分钟）</label>
                                <input type="number" class="form-control" id="minuteLimit" placeholder="1440" value="1440" min="720" max="10080" name="minuteLimit">
                            </div>

                            <div class="alert alert-warning" role="alert">
                                提交后，请到新打开的页面耐心等待报告生成完成再查看。<br>如人数较多或时期较长，可能需要等待较长时间。
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="reportIKown" required>
                                    <label class="form-check-label" for="reportIKown">
                                        我已知晓
                                    </label>
                                </div>
                            </div>

                            <button type="submit" id="genReportSubmit" class="btn btn-outline-info btn-block">开始生成报告</button>

                        </form>

                    </div>
                    <div class="col-sm-2"></div>
                </div>
            </div>

            <!--searchUserTab-->
            <div class="tab-pane fade" id="searchUser" role="tabpanel" aria-labelledby="searchUser-tab">
                <div class="row">
                    <div class="col-sm-2"></div>
                    <div class="col-sm-8">

                        <form id="searchUserForm" action="/backend/searchUser" method="post">
                            <!--role-->
                            <div class="form-group">
                                <label for="UserRole">用户角色(选填)</label>
                                <select class="form-control" id="UserRole" name="UserRole">
                                    <option selected="selected" value=''></option>
                                    <option value="patient">普通</option>
                                    <option value="doctor">医生</option>
                                    <option value="submitted">医生(待审核)</option>
                                    <option value="rejected">医生(被拒)</option>
                                    <option value="child">家属</option>
                                </select>
                            </div>
                            <!--name-->
                            <div class="form-group">
                                <label for="UserName">用户昵称</label>
                                <input type="text" class="form-control" id="UserName" placeholder="请填写全称" name="UserName">
                            </div>
                            <!--mobile-->
                            <div class="form-group">
                                <label for="UserMobile">用户手机号</label>
                                <input type="text" class="form-control" id="UserMobile" placeholder="" name="UserMobile">
                            </div>
                            <!--email-->
                            <div class="form-group">
                                <label for="UserEmail">用户邮箱</label>
                                <input type="email" class="form-control" id="UserEmail" placeholder="" name="UserEmail">
                            </div>

                            <!--提交-->
                            <button type="submit" id="searchUserSubmit" class="btn btn-outline-info btn-block">搜索</button>

                        </form>

                        <!--结果-->
                        <div class="alert alert-danger searchUser result" role="alert">搜索失败，请稍后重试。</div>
                        <div class="alert alert-success searchUser result" role="alert"><br></div>
                    </div>
                    <div class="col-sm-2"></div>
                </div>

                <table id="searchUserTable"></table>

            </div>
        </div>
    </div>
</div>


<!--footer-->
<div class="footerPage"></div>
<!--footer over-->

<script>

    $(function(){
        /*公共部分
         * 导航栏
         * footer CopyRight
         */
        $(".headerPage").load("/header.html");
        $(".footerPage").load("/footer.html");

        // 进入时重定位tab
        let tab = getQueryString('tab');
        console.log(tab);
        $('#'+tab+'-tab').tab('show');

    });

    // 平时点击切换tab
    $('#mainTab a').on('click', function (e) {
        e.preventDefault();
        $(this).tab('show');
    })


    // 获取请求参数
    function getQueryString(name) {
        let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        let r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }


    /** 获取genRedeemCodeForm后台数据  */
    $(function(){

        // prepare the form when the DOM is ready
        let genRedeemCodeFormOptions = {
            // target:        '#',   // target element(s) to be updated with server response
            beforeSubmit:  showRequest,  // pre-submit callback
            success:       showResponse,  // post-submit callback

            // other available options:
            //url:       url         // override for form's 'action' attribute
            //type:      type        // 'get' or 'post', override for form's 'method' attribut
            dataType:  'json',  // 'xml', 'script', or 'json' (expected server response type)
            //clearForm: true        // clear all form fields after successful submit
            //resetForm: true        // reset the form after successful submit

            // $.ajax options can be used here too, for example:
            //timeout:   3000

            successSelector: $('.alert-success.genRedeemCode.result'),
            failSelector: $('.alert-danger.genRedeemCode.result')
        };
        genRedeemCodeFormOptions.successText = genRedeemCodeFormOptions.successSelector.html();

        // bind form using 'ajaxForm'
        $('#genRedeemCodeForm').ajaxForm(genRedeemCodeFormOptions);

        // pre-submit callback
        function showRequest(formData, jqForm, options) {
            // formData is an array; here we use $.param to convert it to a string to display it
            // but the form plugin does this for you automatically when it submits the data
            let queryString = $.param(formData);

            // jqForm is a jQuery object encapsulating the form element.  To access the
            // DOM element for the form do this:
            // let formElement = jqForm[0];

            console.log('About to submit:' , queryString);

            // here we could return false to prevent the form from being submitted;
            // returning anything other than false will allow the form submit to continue
            return true;
        }

        // post-submit callback
        function showResponse(data, a, b, c, d, e)  {
            // for normal html responses, the first argument to the success callback
            // is the XMLHttpRequest object's responseText property

            // if the ajaxForm method was passed an Options Object with the dataType
            // property set to 'xml' then the first argument to the success callback
            // is the XMLHttpRequest object's responseXML property

            // if the ajaxForm method was passed an Options Object with the dataType
            // property set to 'json' then the first argument to the success callback
            // is the json data object returned by the server

            console.log('status: ', data, a, b, c, d, e);

            if (!data.error){
                genRedeemCodeFormOptions.successSelector.html(genRedeemCodeFormOptions.successText + data.data.redeemCodes.join('<br>'));
                genRedeemCodeFormOptions.failSelector.hide();
                genRedeemCodeFormOptions.successSelector.show();
            }else {
                genRedeemCodeFormOptions.failSelector.html(data.message);
                genRedeemCodeFormOptions.successSelector.hide();
                genRedeemCodeFormOptions.failSelector.show();
            }
        }
    });


    /** 报告  */
    $(function () {
        const startObj = $('#reportTimeStart');
        const endObj = $('#reportTimeEnd');

        startObj.datetimepicker({
            format: 'YYYY-MM-DD'
        });
        endObj.datetimepicker({
            format: 'YYYY-MM-DD'
        });

        startObj.on("change.datetimepicker", function (e) {
            endObj.datetimepicker('minDate', e.date);
        });
        endObj.on("change.datetimepicker", function (e) {
            startObj.datetimepicker('maxDate', e.date);
        });

    });


    /** 获取searchUserForm后台数据  */
    $(function(){

            // prepare the form when the DOM is ready
        let searchUserFormOptions = {
            // target:        '#',   // target element(s) to be updated with server response
            beforeSubmit:  showRequest,  // pre-submit callback
            success:       showResponse,  // post-submit callback

            // other available options:
            //url:       url         // override for form's 'action' attribute
            //type:      type        // 'get' or 'post', override for form's 'method' attribut
            dataType:  'json',  // 'xml', 'script', or 'json' (expected server response type)
            //clearForm: true        // clear all form fields after successful submit
            //resetForm: true        // reset the form after successful submit

            // $.ajax options can be used here too, for example:
            //timeout:   3000

            successSelector: $('.alert-success.searchUser.result'),
            failSelector: $('.alert-danger.searchUser.result'),
            tableSelector: $("#searchUserTable")
        };

        // bind form using 'ajaxForm'
        $('#searchUserForm').ajaxForm(searchUserFormOptions);

        // pre-submit callback
        function showRequest(formData, jqForm, options) {
            // formData is an array; here we use $.param to convert it to a string to display it
            // but the form plugin does this for you automatically when it submits the data
            let queryString = $.param(formData);

            // jqForm is a jQuery object encapsulating the form element.  To access the
            // DOM element for the form do this:
            // let formElement = jqForm[0];

            console.log('About to submit:' , queryString);

            // here we could return false to prevent the form from being submitted;
            // returning anything other than false will allow the form submit to continue
            return true;
        }

        // post-submit callback
        function showResponse(data, a, b, c, d, e)  {
            // for normal html responses, the first argument to the success callback
            // is the XMLHttpRequest object's responseText property

            // if the ajaxForm method was passed an Options Object with the dataType
            // property set to 'xml' then the first argument to the success callback
            // is the XMLHttpRequest object's responseXML property

            // if the ajaxForm method was passed an Options Object with the dataType
            // property set to 'json' then the first argument to the success callback
            // is the json data object returned by the server

            console.log('status: ', data, a, b, c, d, e);

            if (!data.error){
                let texts = `搜索到${data.data.length}个用户。`;
                searchUserFormOptions.successSelector.html(texts);
                searchUserFormOptions.failSelector.hide();
                searchUserFormOptions.successSelector.show();
                searchUserFormOptions.tableSelector.bootstrapTable('load', data.data);

            }else {
                searchUserFormOptions.failSelector.html(data.message);
                searchUserFormOptions.successSelector.hide();
                searchUserFormOptions.failSelector.show();

            }
        }

        searchUserFormOptions.tableSelector.bootstrapTable({
            // url: "/backend/searchUser",
            // //这个接口需要处理bootstrap table传递的固定参数,并返回特定格式的json数据
            // //默认值为 'limit',传给服务端的参数为：limit, offset, search, sort, order Else
            // //请求方法
            // method: 'get',                      //请求方式（*）
            toolbar: '#toolbar',                //工具按钮用哪个容器
            striped: true,                      //是否显示行间隔色
            cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            pagination: true,                   //是否显示分页（*）
            sortable: false,                     //是否启用排序
            sortOrder: "asc",                   //排序方式
            // queryParams: queryParams,//传递参数（*）
            paginationLoop: false,
            sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 10,                       //每页的记录行数（*）
            pageList: [10, 25, 50, 100, 'All']	,        //可供选择的每页的行数（*）
            search: true,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
            strictSearch: false,                //全匹配
            showColumns: false,                  //是否显示所有的列
            showRefresh: false,                  //是否显示刷新按钮
            minimumCountColumns: 2,             //最少允许的列数
            clickToSelect: true,                //是否启用点击选中行
            // height: 500,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
            uniqueId: "_id",                     //每一行的唯一标识，一般为主键列
            showToggle:true,                    //是否显示详细视图和列表视图的切换按钮
            cardView: false,                    //是否显示详细视图
            detailView: false,                   //是否显示父子表
            showPaginationSwitch: true,
            showFullscreen: false,
            idField : "_id",

            columns: [{
                field: "_id",
                title: '_id'
                // radio: true,
                // checkbox: true,
            }, {
                field: "name",
                title: "name"
            }, {
                field: "email",
                title: "email"
            }, {
                field: "mobile",
                title: "mobile"
            }, {
                field: "role",
                title: "role"
            }, {
                field: "sex",
                title: "sex"
            }, {
                field: "birthday",
                title: "birthday"
            }, {
                field: "height",
                title: "height"
            }, {
                field: "weight",
                title: "weight"
            }, {
                field: "jjmobile",
                title: "jjmobile"
            }, {
                field: "ossurl",
                title: "ossurl"
            }
            ]
        });
    });




</script>


<script type="text/javascript">

</script>

</body>
</html>